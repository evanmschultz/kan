package domain

import (
	"bytes"
	"encoding/json"
	"strings"
	"time"
)

// Project represents project data used by this package.
type Project struct {
	ID          string
	Slug        string
	Name        string
	Description string
	Kind        KindID
	Metadata    ProjectMetadata
	CreatedAt   time.Time
	UpdatedAt   time.Time
	ArchivedAt  *time.Time
}

// ProjectCapabilityPolicy stores project-level capability and override policy values.
type ProjectCapabilityPolicy struct {
	AllowOrchestratorOverride bool
	OrchestratorOverrideToken string
	AllowEqualScopeDelegation bool
}

// ProjectMetadata represents project metadata data used by this package.
type ProjectMetadata struct {
	Owner             string
	Icon              string
	Color             string
	Homepage          string
	Tags              []string
	StandardsMarkdown string
	KindPayload       json.RawMessage
	CapabilityPolicy  ProjectCapabilityPolicy
}

// NewProject constructs a new value for this package.
func NewProject(id, name, description string, now time.Time) (Project, error) {
	id = strings.TrimSpace(id)
	name = strings.TrimSpace(name)
	if id == "" {
		return Project{}, ErrInvalidID
	}
	if name == "" {
		return Project{}, ErrInvalidName
	}

	slug := normalizeSlug(name)

	return Project{
		ID:          id,
		Slug:        slug,
		Name:        name,
		Description: strings.TrimSpace(description),
		Kind:        DefaultProjectKind,
		Metadata:    ProjectMetadata{},
		CreatedAt:   now.UTC(),
		UpdatedAt:   now.UTC(),
	}, nil
}

// Rename renames the requested operation.
func (p *Project) Rename(name string, now time.Time) error {
	name = strings.TrimSpace(name)
	if name == "" {
		return ErrInvalidName
	}
	p.Name = name
	p.Slug = normalizeSlug(name)
	p.UpdatedAt = now.UTC()
	return nil
}

// SetKind sets the project kind identifier.
func (p *Project) SetKind(kind KindID, now time.Time) error {
	kind = NormalizeKindID(kind)
	if kind == "" {
		return ErrInvalidKindID
	}
	p.Kind = kind
	p.UpdatedAt = now.UTC()
	return nil
}

// UpdateDetails updates state for the requested operation.
func (p *Project) UpdateDetails(name, description string, metadata ProjectMetadata, now time.Time) error {
	name = strings.TrimSpace(name)
	if name == "" {
		return ErrInvalidName
	}
	p.Name = name
	p.Slug = normalizeSlug(name)
	p.Description = strings.TrimSpace(description)
	normalized, err := normalizeProjectMetadata(metadata)
	if err != nil {
		return err
	}
	p.Metadata = normalized
	p.UpdatedAt = now.UTC()
	return nil
}

// Archive archives the requested operation.
func (p *Project) Archive(now time.Time) {
	ts := now.UTC()
	p.ArchivedAt = &ts
	p.UpdatedAt = ts
}

// Restore restores the requested operation.
func (p *Project) Restore(now time.Time) {
	p.ArchivedAt = nil
	p.UpdatedAt = now.UTC()
}

// normalizeSlug normalizes slug.
func normalizeSlug(s string) string {
	s = strings.ToLower(strings.TrimSpace(s))
	if s == "" {
		return ""
	}

	var b strings.Builder
	prevDash := false
	for _, r := range s {
		switch {
		case r >= 'a' && r <= 'z':
			b.WriteRune(r)
			prevDash = false
		case r >= '0' && r <= '9':
			b.WriteRune(r)
			prevDash = false
		default:
			if !prevDash {
				b.WriteByte('-')
				prevDash = true
			}
		}
	}
	out := strings.Trim(b.String(), "-")
	return out
}

// normalizeProjectMetadata normalizes project metadata.
func normalizeProjectMetadata(meta ProjectMetadata) (ProjectMetadata, error) {
	meta.Owner = strings.TrimSpace(meta.Owner)
	meta.Icon = strings.TrimSpace(meta.Icon)
	meta.Color = strings.TrimSpace(meta.Color)
	meta.Homepage = strings.TrimSpace(meta.Homepage)
	meta.Tags = normalizeLabels(meta.Tags)
	meta.StandardsMarkdown = strings.TrimSpace(meta.StandardsMarkdown)
	meta.KindPayload = bytes.TrimSpace(meta.KindPayload)
	if len(meta.KindPayload) > 0 && !json.Valid(meta.KindPayload) {
		return ProjectMetadata{}, ErrInvalidKindPayload
	}
	meta.CapabilityPolicy.OrchestratorOverrideToken = strings.TrimSpace(meta.CapabilityPolicy.OrchestratorOverrideToken)
	return meta, nil
}

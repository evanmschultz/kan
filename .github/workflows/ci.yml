name: ci

on:
  push:
  pull_request:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

permissions:
  contents: read

jobs:
  test-matrix:
    name: check (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true
      - uses: taiki-e/install-action@just
      - name: Run CI pipeline (unix)
        if: runner.os != 'Windows'
        shell: bash
        run: just check
      - name: Run CI pipeline (windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: just check

  full-gate-linux:
    name: full gate (ubuntu-latest)
    runs-on: ubuntu-latest
    needs: test-matrix
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true
      - uses: taiki-e/install-action@just
      - name: Run full CI gate
        run: just ci

  release-snapshot-check:
    name: release snapshot check
    runs-on: ubuntu-latest
    needs: full-gate-linux
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true
      - name: Verify required entrypoint sources are tracked
        run: git ls-files --error-unmatch cmd/kan/main.go cmd/kan/main_test.go
      - name: Validate goreleaser snapshot
        uses: goreleaser/goreleaser-action@v6
        with:
          version: "~> v2"
          args: release --snapshot --clean --skip=publish

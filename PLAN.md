# Kan Plan

Created: 2026-02-21
Updated: 2026-02-27
Status: Execution plan locked; immediate next action is collaborative test closeout

## 1) Primary Goal

Finish `kan` as a reliable local-first planning system for human + agent collaboration, with:
1. stable TUI workflows,
2. strict mutation guardrails,
3. MCP/HTTP parity for critical flows,
4. evidence-backed validation and closeout.

## 2) Canonical Active Docs

1. `PLAN.md` (this file): execution plan and phase/task tracker.
2. `COLLABORATIVE_POST_FIX_VALIDATION_WORKSHEET.md`: canonical collaborative validation evidence.
3. `COLLAB_E2E_REMEDIATION_PLAN_WORKLOG.md`: remediation requirements and checkpoints.
4. `MCP_FULL_TESTER_AGENT_RUNBOOK.md`: canonical MCP full-sweep run protocol.
5. `MCP_DOGFOODING_WORKSHEET.md`: MCP/HTTP dogfooding worksheet.
6. `PARALLEL_AGENT_RUNBOOK.md`: subagent orchestration policy.

## 3) Locked Constraints And References

### 3.1 Locked Constraints

1. Path portability rules:
   - no absolute-path export,
   - portable refs only (`root_alias` + relative paths),
   - import fails on unresolved required refs/root mappings.
2. Project linkage model stays `workspace_linked = true|false`.
3. Non-user mutations remain lease-gated and fail-closed.
4. Completion contracts remain required for completion semantics.
5. Attention/blocker escalation remains required for unresolved consensus/approval flows.

### 3.2 MCP References (Required)

1. MCP tool discovery/update:
   - https://modelcontextprotocol.io/legacy/concepts/tools#tool-discovery-and-updates
2. MCP roots/client concepts:
   - https://modelcontextprotocol.io/specification/2025-03-26/client/roots
   - https://modelcontextprotocol.io/docs/learn/client-concepts
3. MCP-Go:
   - https://github.com/mark3labs/mcp-go
   - Context7 id: `/mark3labs/mcp-go`

## 4) Global Subagent Execution Contract (Applies To Every Phase)

1. Orchestrator/integrator is the only writer for `PLAN.md` phase status and completion markers.
2. Each phase is split into parallel lanes with non-overlapping lock scopes.
3. Worker lanes run scoped checks only (`just test-pkg <pkg>`); no repo-wide gates in worker lanes.
4. Integrator runs repo-wide gates (`just check`, `just ci`, `just test-golden`) at phase integration points.
5. Worker handoff must include files changed, commands run, outcomes, acceptance checklist, and unresolved risks.
6. No lane closes without explicit acceptance evidence.

## 5) Phase Plan (Complete Execution Sequence)

## Phase 0: Collaborative Test Closeout (Immediate Next Action)

Objective:
- finish all collaborative test work and update worksheet evidence to current truth.

Tasks:
1. `P0-T01` Run remaining manual TUI validation for C4/C6/C9/C10/C11/C12/C13.
2. `P0-T02` Run archived/search/keybinding targeted checks and record PASS/FAIL/BLOCKED.
3. `P0-T03` Re-run focused MCP checks for known failures (`kan_restore_task`, `capture_state` readiness).
4. `P0-T04` Capture logging/help discoverability evidence (`./kan --help`, `./kan serve --help`, runtime log parity).
5. `P0-T05` Fill all blank checkpoints and sign-off blocks in `MCP_DOGFOODING_WORKSHEET.md`.
6. `P0-T06` Update `COLLABORATIVE_POST_FIX_VALIDATION_WORKSHEET.md` with final evidence paths and verdict.

Parallel lane split:
1. `P0-LA` (TUI manual validation lane)
   - lock scope: `COLLABORATIVE_POST_FIX_VALIDATION_WORKSHEET.md`, `.tmp/**` evidence artifacts.
2. `P0-LB` (MCP/HTTP verification lane)
   - lock scope: `MCP_DOGFOODING_WORKSHEET.md`, `.tmp/**` protocol/evidence artifacts.
3. `P0-LC` (logging/help verification lane)
   - lock scope: `.tmp/**` logging artifacts, worksheet evidence rows for logging sections.

Exit criteria:
1. All P0 tasks have explicit PASS/FAIL/BLOCKED outcomes with evidence.
2. No blank sign-off fields remain in active worksheets.
3. Open failures are converted into explicit implementation tasks in Phase 1.

## Phase 1: Critical Remediation Fixes

Objective:
- fix currently known blockers from collaborative validation.

Tasks:
1. `P1-T01` Fix `kan_restore_task` MCP contract/guard mismatch.
2. `P1-T02` Fix logging discoverability and runtime log-sink parity gaps.
3. `P1-T03` Implement deterministic external-mutation refresh behavior in active TUI views.
4. `P1-T04` Complete notifications/notices behavior requirements (global count, quick-nav, drill-in).
5. `P1-T05` Reconcile archived/search/key policy behavior with expected UX.

Parallel lane split:
1. `P1-LA` (transport contract lane)
   - lock scope: `internal/adapters/server/mcpapi/**`, `internal/adapters/server/httpapi/**`, related tests.
2. `P1-LB` (TUI notices/refresh lane)
   - lock scope: `internal/tui/**`, related tests/golden fixtures.
3. `P1-LC` (logging/help lane)
   - lock scope: `cmd/kan/**`, `internal/adapters/server/**`, `internal/config/**`, related tests.

Exit criteria:
1. P1 defects are closed with test evidence.
2. P0 failed checks are re-run and pass or are explicitly reclassified with rationale.

## Phase 2: Contract And Data-Model Hardening

Objective:
- lock unresolved design contracts that block stable MCP/HTTP closeout.

Tasks:
1. `P2-T01` Finalize attention storage model (`table` vs embedded JSON) and migration plan.
2. `P2-T02` Finalize attention taxonomy and lifecycle/override semantics.
3. `P2-T03` Finalize pagination/cursor contract for attention and related list surfaces.
4. `P2-T04` Finalize unresolved MCP contract decisions from prior open-question sets.
5. `P2-T05` Close snapshot portability completeness gaps for collaboration-grade import/export.
6. `P2-T06` Carry unresolved override-token documentation obligations into active docs.

Parallel lane split:
1. `P2-LA` (domain/app contract lane)
   - lock scope: `internal/domain/**`, `internal/app/**`, tests.
2. `P2-LB` (storage/schema lane)
   - lock scope: `internal/adapters/storage/sqlite/**`, migration/test fixtures.
3. `P2-LC` (transport schema/docs lane)
   - lock scope: `internal/adapters/server/**`, `README.md`, `PLAN.md`, MCP worksheets.

Exit criteria:
1. Contract decisions are encoded in code/tests/docs.
2. No unresolved “open contract” placeholders remain for in-scope MVP behavior.

## Phase 3: Full Validation And Gate Pass

Objective:
- produce final evidence-backed quality pass for current scope.

Tasks:
1. `P3-T01` Run `just check`.
2. `P3-T02` Run `just ci`.
3. `P3-T03` Run `just test-golden`.
4. `P3-T04` Execute MCP full-sweep per `MCP_FULL_TESTER_AGENT_RUNBOOK.md` and capture final report.
5. `P3-T05` Re-run collaborative worksheet and dogfooding worksheet with final verdicts.

Parallel lane split:
1. `P3-LA` (automated-gates lane)
   - lock scope: test outputs and `.tmp/**` gate artifacts.
2. `P3-LB` (MCP runbook lane)
   - lock scope: MCP run artifacts/report files.
3. `P3-LC` (manual validation lane)
   - lock scope: collaborative worksheet evidence rows/screenshots.

Exit criteria:
1. Required gates pass.
2. Worksheets have final, non-blank verdicts.
3. Remaining risks are explicitly documented with owner/next step.

## Phase 4: Docs Finalization And Closeout

Objective:
- finalize accurate active docs and remove stale narrative drift.

Tasks:
1. `P4-T01` Ensure `README.md` and `AGENTS.md` reflect actual current behavior.
2. `P4-T02` Ensure `PLAN.md` statuses match worksheet/runbook evidence.
3. `P4-T03` Remove or archive stale planning/status statements that conflict with final evidence.
4. `P4-T04` Produce final closeout summary and commit sequencing plan.

Parallel lane split:
1. `P4-LA` (product docs lane)
   - lock scope: `README.md`, `CONTRIBUTING.md`.
2. `P4-LB` (process docs lane)
   - lock scope: `AGENTS.md`, `PARALLEL_AGENT_RUNBOOK.md`.
3. `P4-LC` (plan/worksheet lane)
   - lock scope: `PLAN.md`, collab worksheets/worklogs.

Exit criteria:
1. Active docs are internally consistent.
2. No stale “not implemented” statements remain for implemented behavior.

## Phase 5: Deferred Roadmap (Not In Immediate Finish Scope)

Objective:
- preserve future work without blocking finish of current scope.

Tasks:
1. `P5-T01` Advanced import/export divergence reconciliation tooling.
2. `P5-T02` Broader policy-driven tool-surface controls and template expansion.
3. `P5-T03` Multi-user/team auth-tenancy and security hardening.

Parallel lane split:
1. `P5-LA` (import/export research lane).
2. `P5-LB` (policy/template lane).
3. `P5-LC` (security/tenancy lane).

Exit criteria:
1. Roadmap items are explicitly scoped and non-blocking for current finish target.

## 6) Immediate Next Action Lock

The very next work to run is **Phase 0: Collaborative Test Closeout**.
No new feature phase should start until Phase 0 produces updated evidence and explicit task outcomes.

## 7) Definition Of Done For Current Finish Target

1. Phase 0 through Phase 4 are complete.
2. Known blocking defects from collaborative validation are closed or explicitly accepted with owner + follow-up.
3. `just check`, `just ci`, and `just test-golden` pass on the final integrated state.
4. Collaborative and dogfooding worksheets have final non-blank sign-off verdicts.
5. Active docs are accurate and mutually consistent.

## 8) Lightweight Execution Log

### 2026-02-27: PLAN Restructure For Full Phase/Lane Execution

Objective:
- convert `PLAN.md` into a complete phase/task plan with explicit parallel-lane execution for every phase.

Result:
- phases, task IDs, lane lock scopes, and exit criteria are now defined end-to-end,
- collaborative test closeout is explicitly locked as immediate next action.

Test status:
- `test_not_applicable` (docs-only change).
